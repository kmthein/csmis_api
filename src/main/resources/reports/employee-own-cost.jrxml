<?xml version="1.0" encoding="UTF-8"?>
<!-- Created with Jaspersoft Studio version 6.20.5.final using JasperReports Library version 6.20.5-3efcf2e67f959db3888d79f73dde2dbd7acb4f8e  -->
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="employee-own-cost" pageWidth="595" pageHeight="842" columnWidth="555" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20" uuid="f91b8d87-27ee-47c6-ba23-bb8d9e4dfad9">
	<property name="com.jaspersoft.studio.data.sql.tables" value=""/>
	<property name="com.jaspersoft.studio.data.defaultdataadapter" value="csmis dataadapter-Database JDBC Connection"/>
	<parameter name="report_type" class="java.lang.String"/>
	<parameter name="date" class="java.util.Date"/>
	<parameter name="start_date" class="java.util.Date"/>
	<parameter name="end_date" class="java.util.Date"/>
	<parameter name="month" class="java.lang.Integer"/>
	<parameter name="year" class="java.lang.Integer"/>
	<queryString language="SQL">
		<![CDATA[WITH calculated_data AS (
    SELECT 
        u.name AS name, 
        u.staff_id AS staff_id, 
        SUM(l.price - (l.company_rate / 100) * l.price) AS amount
    FROM (
        SELECT dar.user_id AS user_id, dar.date AS date 
        FROM door_access_record dar
        WHERE 
			(
			    ($P{report_type} = 'daily' AND dar.date = $P{date}) OR
			    ($P{report_type} = 'weekly' AND dar.date BETWEEN $P{start_date} AND $P{end_date}) OR
			    ($P{report_type} = 'monthly' AND EXTRACT(MONTH FROM dar.date) = $P{month} AND EXTRACT(YEAR FROM dar.date) = $P{year})
			)  
        AND NOT EXISTS (
            SELECT user_id  
            FROM user_has_lunch uhl
            WHERE dar.user_id = uhl.user_id 
            AND dar.date = uhl.dt
        )
        
        UNION ALL

        SELECT uhl.user_id AS user_id, uhl.dt AS date 
        FROM user_has_lunch uhl
        WHERE 
        	(
			    ($P{report_type} = 'daily' AND uhl.dt = $P{date}) OR
			    ($P{report_type} = 'weekly' AND uhl.dt BETWEEN $P{start_date} AND $P{end_date}) OR
			    ($P{report_type} = 'monthly' AND EXTRACT(MONTH FROM uhl.dt) = $P{month} AND EXTRACT(YEAR FROM uhl.dt) = $P{year})
			)
        	 
    ) combined
    JOIN user u ON combined.user_id = u.id
    JOIN lunch l ON combined.date = l.date
    GROUP BY u.name, u.staff_id
)
SELECT 
    name, 
    staff_id, 
    amount, 
    SUM(amount) OVER () AS total_amount
FROM calculated_data
ORDER BY staff_id;]]>
	</queryString>
	<field name="name" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.name" value="name"/>
		<property name="com.jaspersoft.studio.field.label" value="name"/>
	</field>
	<field name="staff_id" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.name" value="staff_id"/>
		<property name="com.jaspersoft.studio.field.label" value="staff_id"/>
	</field>
	<field name="amount" class="java.lang.Double">
		<property name="com.jaspersoft.studio.field.name" value="amount"/>
		<property name="com.jaspersoft.studio.field.label" value="amount"/>
	</field>
	<field name="total_amount" class="java.lang.Double">
		<property name="com.jaspersoft.studio.field.name" value="total_amount"/>
		<property name="com.jaspersoft.studio.field.label" value="total_amount"/>
	</field>
	<background>
		<band splitType="Stretch"/>
	</background>
	<title>
		<band height="80" splitType="Stretch">
			<image>
				<reportElement x="0" y="30" width="69" height="49" uuid="8a1cd3cf-2f04-4ded-ae0f-19ea0f86d994"/>
				<imageExpression><![CDATA[net.sf.jasperreports.engine.util.JRLoader.loadBytes(getClass().getResource("/images/DAT Logo.png"))]]></imageExpression>
			</image>
			<staticText>
				<reportElement x="355" y="30" width="84" height="29" uuid="722a68ee-548c-4226-87b8-e1ac494f5ca2"/>
				<textElement textAlignment="Left" verticalAlignment="Top">
					<font size="10" isBold="false"/>
				</textElement>
				<text><![CDATA[Report Name :]]></text>
			</staticText>
			<textField>
				<reportElement x="440" y="30" width="121" height="27" uuid="42ef41f6-5f56-49a8-a66f-70c731fbfdc4"/>
				<textFieldExpression><![CDATA["Employee-Own-Costs          (For "+ 
          ($P{report_type}.equals("daily") ? "Daily" : 
          ($P{report_type}.equals("weekly") ? "Weekly" : 
          ($P{report_type}.equals("monthly") ? "Monthly" : 
          ($P{report_type}.equals("yearly") ? "Yearly" : "Unknown"))))+")"]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="355" y="60" width="84" height="20" uuid="18387534-8b56-4fd7-a2d3-0af8562ce94c"/>
				<textElement textAlignment="Left">
					<font size="10" isBold="false"/>
				</textElement>
				<text><![CDATA[Report Date   :]]></text>
			</staticText>
			<textField pattern="MMMMM dd, yyyy">
				<reportElement x="440" y="60" width="100" height="20" uuid="858ef8e0-fcea-467d-823f-9887d4984b9c"/>
				<textElement textAlignment="Left"/>
				<textFieldExpression><![CDATA[new java.util.Date()]]></textFieldExpression>
			</textField>
		</band>
	</title>
	<columnHeader>
		<band height="41" splitType="Stretch">
			<staticText>
				<reportElement mode="Opaque" x="20" y="10" width="158" height="30" forecolor="#FFFFFF" backcolor="#336699" uuid="10684ac1-e7a2-4177-b356-c5dbb8093093">
					<property name="com.jaspersoft.studio.spreadsheet.connectionID" value="64a70699-8d1d-43b9-a531-b2557e16dcf9"/>
				</reportElement>
				<box leftPadding="1" rightPadding="1">
					<pen lineWidth="0.5"/>
					<topPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[Name]]></text>
			</staticText>
			<staticText>
				<reportElement mode="Opaque" x="178" y="10" width="158" height="30" forecolor="#FFFFFF" backcolor="#336699" uuid="3cfe3938-098e-4a9e-b7f5-1852f2a69621">
					<property name="com.jaspersoft.studio.spreadsheet.connectionID" value="64a70699-8d1d-43b9-a531-b2557e16dcf9"/>
				</reportElement>
				<box leftPadding="1" rightPadding="1">
					<pen lineWidth="0.5"/>
					<topPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[Staff_Id]]></text>
			</staticText>
			<staticText>
				<reportElement mode="Opaque" x="336" y="10" width="158" height="30" forecolor="#FFFFFF" backcolor="#336699" uuid="359f3fe1-894a-43a1-ab03-65fa420c62ff">
					<property name="com.jaspersoft.studio.spreadsheet.connectionID" value="64a70699-8d1d-43b9-a531-b2557e16dcf9"/>
				</reportElement>
				<box leftPadding="1" rightPadding="1">
					<pen lineWidth="0.5"/>
					<topPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[Amount]]></text>
			</staticText>
		</band>
	</columnHeader>
	<detail>
		<band height="26" splitType="Stretch">
			<textField>
				<reportElement x="20" y="0" width="158" height="26" uuid="243b5810-9450-418f-8921-829105bde69d">
					<property name="com.jaspersoft.studio.spreadsheet.connectionID" value="b8793c8f-1f79-4362-9067-f863fa206891"/>
				</reportElement>
				<box leftPadding="1" rightPadding="1">
					<pen lineWidth="0.5"/>
					<topPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression><![CDATA[$F{name}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="178" y="0" width="158" height="26" uuid="f01cf9ca-86e5-4d28-81d2-a5ea9837d522">
					<property name="com.jaspersoft.studio.spreadsheet.connectionID" value="b8793c8f-1f79-4362-9067-f863fa206891"/>
				</reportElement>
				<box leftPadding="1" rightPadding="1">
					<pen lineWidth="0.5"/>
					<topPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression><![CDATA[$F{staff_id}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="336" y="0" width="158" height="26" uuid="818042f8-8f4e-4541-ab07-b9fe749938fb">
					<property name="com.jaspersoft.studio.spreadsheet.connectionID" value="b8793c8f-1f79-4362-9067-f863fa206891"/>
				</reportElement>
				<box leftPadding="1" rightPadding="1">
					<pen lineWidth="0.5"/>
					<topPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression><![CDATA[$F{amount}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<pageFooter>
		<band height="55" splitType="Stretch">
			<textField>
				<reportElement x="375" y="25" width="100" height="30" uuid="b94bf97d-e922-49ee-b2c5-8caf900c2d44"/>
				<textElement textAlignment="Right"/>
				<textFieldExpression><![CDATA["Page " + $V{PAGE_NUMBER}]]></textFieldExpression>
			</textField>
			<textField evaluationTime="Report">
				<reportElement x="475" y="25" width="100" height="30" uuid="d76c242b-21c0-4307-93bd-8e31336fda2e"/>
				<textElement textAlignment="Left"/>
				<textFieldExpression><![CDATA[" of " + $V{PAGE_NUMBER}]]></textFieldExpression>
			</textField>
		</band>
	</pageFooter>
	<summary>
		<band height="42" splitType="Stretch">
			<staticText>
				<reportElement x="20" y="0" width="316" height="30" uuid="e52c8fa3-ec68-41b9-a3db-7555107ab945"/>
				<box>
					<topPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[Total Employee_Costing]]></text>
			</staticText>
			<textField>
				<reportElement x="336" y="0" width="158" height="30" uuid="aa3e68b6-7b62-4723-ab1e-9ec03f3eaf67"/>
				<box>
					<topPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="1.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression><![CDATA[$F{total_amount}]]></textFieldExpression>
			</textField>
		</band>
	</summary>
</jasperReport>
